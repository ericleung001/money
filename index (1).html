<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheet è¨˜å¸³ (13æ—¥åˆ¶)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #333;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { 
            background: #e0f2fe; color: #0369a1; padding: 10px; 
            border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .loading { opacity: 0.6; pointer-events: none; }

        /* å„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .stat-box { background: #f8fafc; padding: 10px; border-radius: 8px; }
        .big-stat { grid-column: 1 / -1; background: #eff6ff; border: 1px solid #dbeafe; }
        .stat-val { font-size: 1.2rem; font-weight: bold; }
        .income { color: var(--success); } .expense { color: var(--danger); }

        /* è¡¨å–®èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
        
        /* åˆ—è¡¨ */
        .list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .del-btn { color: #999; margin-left: 10px; cursor: pointer; }

        /* è¨­å®šå€å¡Š */
        .settings-toggle { text-align: center; margin-bottom: 10px; font-size: 0.8rem; color: #666; cursor: pointer; text-decoration: underline; }
        #settingsArea { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center">â˜ï¸ 13æ—¥åˆ¶è¨˜å¸³ (GoogleåŒæ­¥ç‰ˆ)</h2>
    
    <div class="status-bar">
        <span id="statusText">æº–å‚™å°±ç·’ (æœ¬æ©Ÿæ¨¡å¼)</span>
        <span id="loadingIcon" style="display:none">â³</span>
    </div>

    <div class="settings-toggle" onclick="toggleSettings()">âš™ï¸ è¨­å®š Google Sheeté€£çµ</div>
    <div class="card" id="settingsArea">
        <label>Google Apps Script ç¶²å€ (Web App URL)</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbxgchVQcYddNaTR8hbVF2cr2CMJRvOHP2BMUKETFSHVVPPcsMl3v5JoCplYo1LirZkP/exec" onchange="saveUrl()">
        <small style="color:#666">è²¼ä¸Šå¾Œæœƒè‡ªå‹•å„²å­˜æ–¼ç€è¦½å™¨ã€‚</small>
    </div>

    <div class="btn-group">
        <button class="btn btn-outline" onclick="loadFromGoogle()">ğŸ“¥ å¾é›²ç«¯ä¸‹è¼‰</button>
        <button class="btn btn-outline" onclick="saveToGoogle()">â˜ï¸ å¼·åˆ¶ä¸Šå‚³</button>
    </div>

    <div class="period-info" style="text-align:center; margin-bottom:15px; color:#666; font-size:0.9rem" id="periodDisplay"></div>

    <div class="card dashboard">
        <div class="stat-box big-stat">
            <div style="font-size:0.85rem; color:#64748b">æ¯æ—¥å¯ç”¨</div>
            <div class="stat-val" id="dailyBudget">$0</div>
            <div style="font-size:0.85rem; margin-top:5px">å‰© <span id="daysLeft">0</span> å¤©</div>
        </div>
        <div class="stat-box">
            <div style="font-size:0.85rem">ç¸½æ”¶å…¥</div>
            <div class="stat-val income" id="totalIncome">$0</div>
        </div>
        <div class="stat-box">
            <div style="font-size:0.85rem">ç¸½æ”¯å‡º</div>
            <div class="stat-val expense" id="totalExpense">$0</div>
        </div>
        <div class="stat-box" style="grid-column: 1/-1">
            <div style="font-size:0.85rem">å‰©é¤˜é ç®—</div>
            <div class="stat-val" id="balance">$0</div>
        </div>
    </div>

    <div class="card">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px">
            <select id="type"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select>
            <input type="date" id="date">
        </div>
        <input type="number" id="amount" placeholder="é‡‘é¡" inputmode="decimal">
        <input type="text" id="category" placeholder="åˆ†é¡ (å¦‚: åˆé¤)" list="catList">
        <datalist id="catList">
            <option value="è†³é£Ÿ"><option value="äº¤é€š"><option value="è³¼ç‰©"><option value="å¨›æ¨‚"><option value="å›ºå®šé–‹æ”¯">
        </datalist>
        <button class="btn" onclick="addTransaction()">æ–°å¢ä¸¦ä¸Šå‚³</button>
    </div>

    <div class="card">
        <canvas id="expenseChart"></canvas>
        <p id="noDataMsg" style="text-align:center; color:#999; display:none">ç„¡æ•¸æ“š</p>
    </div>

    <div id="list" class="card" style="padding:0; overflow:hidden;"></div>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let chartInstance = null;
    const SCRIPT_URL_KEY = 'google_script_url';

    // åˆå§‹åŒ–
    document.getElementById('date').valueAsDate = new Date();
    const savedUrl = localStorage.getItem(SCRIPT_URL_KEY);
    if(savedUrl) document.getElementById('scriptUrl').value = savedUrl;
    updateUI();
    
    // å¦‚æœæœ‰è¨­å®šç¶²å€ï¼Œæ‰“é–‹ç¶²é æ™‚è‡ªå‹•ä¸‹è¼‰ä¸€æ¬¡ (å¯é¸)
    // if(savedUrl) loadFromGoogle(); 

    function getCycleDates() {
        const now = new Date();
        const d = now.getDate();
        let start = new Date(now), end = new Date(now);
        
        if (d >= 13) {
            start.setDate(13);
            end.setMonth(end.getMonth()+1); end.setDate(12);
        } else {
            start.setMonth(start.getMonth()-1); start.setDate(13);
            end.setDate(12);
        }
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        return { start, end };
    }

    function updateUI() {
        const { start, end } = getCycleDates();
        const now = new Date(); now.setHours(0,0,0,0);
        
        // æ›´æ–°é€±æœŸé¡¯ç¤º
        document.getElementById('periodDisplay').innerText = 
            `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
        
        const daysLeft = Math.ceil((end - now) / (86400000));
        document.getElementById('daysLeft').innerText = Math.max(0, daysLeft);

        // ç¯©é¸èˆ‡è¨ˆç®—
        const currentData = transactions.filter(t => {
            const tDate = new Date(t.date);
            return tDate >= start && tDate <= end;
        });

        const inc = currentData.filter(t=>t.type=='income').reduce((s,t)=>s+t.amount,0);
        const exp = currentData.filter(t=>t.type=='expense').reduce((s,t)=>s+t.amount,0);
        const bal = inc - exp;
        
        document.getElementById('totalIncome').innerText = `$${inc.toFixed(1)}`;
        document.getElementById('totalExpense').innerText = `$${exp.toFixed(1)}`;
        document.getElementById('balance').innerText = `$${bal.toFixed(1)}`;
        document.getElementById('dailyBudget').innerText = daysLeft > 0 ? `$${(bal/daysLeft).toFixed(1)}` : '$0';

        renderList(currentData);
        renderChart(currentData);
    }

    function renderList(data) {
        const list = document.getElementById('list');
        list.innerHTML = '';
        data.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        data.forEach(t => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold">${t.category}</div>
                    <div style="font-size:0.8rem; color:#888">${t.date}</div>
                </div>
                <div style="display:flex; align-items:center">
                    <span class="${t.type}">${t.type=='income'?'+':'-'}$${t.amount}</span>
                    <span class="del-btn" onclick="deleteTx(${t.id})">âŒ</span>
                </div>`;
            list.appendChild(div);
        });
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢
    async function addTransaction() {
        const amt = parseFloat(document.getElementById('amount').value);
        const cat = document.getElementById('category').value;
        const date = document.getElementById('date').value;
        const type = document.getElementById('type').value;

        if(!amt || !cat || !date) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');

        transactions.push({ id: Date.now(), type, date, amount: amt, category: cat });
        saveLocal();
        updateUI();
        
        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('amount').value = '';
        document.getElementById('category').value = '';

        // è‡ªå‹•ä¸Šå‚³
        await saveToGoogle();
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šåˆªé™¤
    async function deleteTx(id) {
        if(!confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
        transactions = transactions.filter(t => t.id !== id);
        saveLocal();
        updateUI();
        await saveToGoogle();
    }

    function saveLocal() {
        localStorage.setItem('transactions', JSON.stringify(transactions));
    }

    // --- Google Sheet æ•´åˆ ---

    function getApiUrl() {
        return document.getElementById('scriptUrl').value.trim();
    }

    function saveUrl() {
        localStorage.setItem(SCRIPT_URL_KEY, getApiUrl());
        alert('ç¶²å€å·²å„²å­˜');
    }

    function toggleSettings() {
        const el = document.getElementById('settingsArea');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function setStatus(msg, isLoading=false) {
        document.getElementById('statusText').innerText = msg;
        document.getElementById('loadingIcon').style.display = isLoading ? 'inline' : 'none';
        document.body.style.pointerEvents = isLoading ? 'none' : 'auto'; // é˜²æ­¢é‡è¤‡é»æ“Š
    }

    async function loadFromGoogle() {
        const url = getApiUrl();
        if(!url) return alert('è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Google Script ç¶²å€');

        setStatus('æ­£åœ¨å¾ Google ä¸‹è¼‰...', true);
        try {
            const res = await fetch(url);
            const data = await res.json();
            transactions = data; // è¦†è“‹æœ¬åœ°è³‡æ–™
            saveLocal();
            updateUI();
            setStatus('åŒæ­¥å®Œæˆ âœ…');
        } catch(e) {
            console.error(e);
            setStatus('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²çµ¡ âŒ');
        }
    }

    async function saveToGoogle() {
        const url = getApiUrl();
        if(!url) {
            setStatus('æœªè¨­å®šç¶²å€ï¼Œåƒ…å„²å­˜æ–¼æœ¬æ©Ÿ');
            return;
        }

        setStatus('æ­£åœ¨ä¸Šå‚³åˆ° Google...', true);
        try {
            // ä½¿ç”¨ Beacon æˆ– text/plain é¿å… CORS é æª¢ (Simple Request)
            const res = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(transactions)
            });
            const result = await res.json();
            if(result.result === 'success') {
                setStatus('å·²ä¸Šå‚³åˆ° Google âœ…');
            } else {
                setStatus('ä¸Šå‚³éŒ¯èª¤ âŒ');
            }
        } catch(e) {
            console.error(e);
            setStatus('é€£ç·šå¤±æ•— âŒ');
        }
    }

    // --- Chart.js åœ–è¡¨ ---
    function renderChart(data) {
        const ctx = document.getElementById('expenseChart');
        const expData = data.filter(t => t.type === 'expense');
        
        if(expData.length === 0) {
            ctx.style.display = 'none';
            document.getElementById('noDataMsg').style.display = 'block';
            return;
        }
        ctx.style.display = 'block';
        document.getElementById('noDataMsg').style.display = 'none';

        const cats = {};
        expData.forEach(t => cats[t.category] = (cats[t.category]||0) + t.amount);

        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{
                    data: Object.values(cats),
                    backgroundColor: ['#ef4444','#f59e0b','#10b981','#3b82f6','#6366f1','#8b5cf6','#ec4899']
                }]
            },
            options: { plugins: { legend: { position: 'right' } } }
        });
    }
</script>
</body>
</html>